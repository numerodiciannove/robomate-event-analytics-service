# Архітектура інжесту та аналітики подій

## Контекст

Система повинна:

* Обробляти **високошвидкісний потік подій користувачів (OLTP)**.
* Забезпечувати **ідемпотентність** при повторній відправці тих самих подій.
* Підтримувати **швидкий розрахунок аналітичних метрик** (DAU, retention, top events) без блокування основного інжесту (OLAP).
* Бути **масштабованою**, **стійкою** та **легкою у підтримці**.
* Використовувати **API для інжесту**, **черги для асинхронної обробки**, та **аналітичні запити**.

---

## Варіанти реалізації

### Бази даних

#### **PostgreSQL**

**Переваги:**

* ACID-транзакції
* Підтримка `JSONB`
* Механізм `ON CONFLICT` для ідемпотентності
* Активна спільнота
* Асинхронна робота через `asyncpg`

**Недоліки:**

* Повільніший для масових OLAP-запитів без індексів чи реплікацій

---

#### **ClickHouse**

**Переваги:**

* Блискавичні OLAP-запити
* Ідеально підходить для аналітики

**Недоліки:**

* Не підходить для OLTP
* Відсутня нативна ідемпотентність
* Ускладнене оновлення записів
* Потребує часу для впровадження та налаштування

---

#### **DuckDB**

**Переваги:**

* Легкий, швидкий для аналітичних операцій
* Можна інтегрувати як локальну OLAP-базу

**Недоліки:**

* Не оптимізований для багатокористувацького OLTP
* Працює синхронно

---

### Висновок щодо баз даних:

> **PostgreSQL** — для **OLTP** та **ідемпотентного інжесту**
> **DuckDB** — для **OLAP** (аналітичні обчислення, ETL)

Таке поєднання забезпечує **високу продуктивність**, **простоту впровадження** та **гнучкість масштабування**.

---

### Веб-фреймворки

#### **FastAPI**

**Переваги:**

* Асинхронність
* Висока швидкість
* Готовність до мікросервісної архітектури
* Гнучке налаштування та підтримка OpenAPI

**Недоліки:**

* Потребує ретельного налаштування middleware, пулів з’єднань і workerів

---

#### **Flask**

**Переваги:** Простий, багато прикладів
**Недоліки:** Синхронний, складно інтегрувати async

---

#### **Django**

**Переваги:** Потужний ORM, багато готових модулів
**Недоліки:** Важкий для мікросервісів, асинхронність лише в нових версіях

---

### Висновок щодо фреймворків:

> **FastAPI** — оптимальний вибір для асинхронного API, JWT-авторизації та інтеграції RateLimiter.

---

### Черги та асинхронна обробка

#### **Celery + Redis**

**Переваги:**

* Надійна, перевірена система таск-черг
* Підтримка асинхронних задач

**Недоліки:**

* Потребує додаткових сервісів
* Складніше масштабування

---

#### **RabbitMQ**

**Переваги:**

* Висока надійність
* Добре працює з великими навантаженнями

**Недоліки:**

* Складна конфігурація та інтеграція

---

#### **Без черги**

**Переваги:**

* Простота архітектури
* Менше залежностей

**Недоліки:**

* Складніше масштабувати при великому потоці подій

---

### Висновок щодо черг:

> На початковому етапі — **без черги**, прямий **async-інжест через asyncpg**.
> При зростанні навантаження — легко додати **Celery + Redis** для асинхронної обробки.

---

## Остаточне рішення

| Компонент                | Технологія              | Призначення                                    |
| ------------------------ | ----------------------- | ---------------------------------------------- |
| **OLTP база даних**      | PostgreSQL + asyncpg    | Ідемпотентний інжест подій                     |
| **OLAP база даних**      | DuckDB + Pandas         | Аналітика, когортний аналіз                    |
| **Веб-фреймворк**        | FastAPI                 | Асинхронний API, JWT авторизація               |
| **Rate limiting**        | Redis + fastapi-limiter | Контроль запитів                               |
| **Черги**                | Без черг (поки що)      | Прямий асинхронний інжест                      |
| **Тестування**           | pytest + pytest-asyncio | Юніт-тести з мокуванням asyncpg                |
| **Валідація**            | Pydantic                | Схеми користувачів, подій                      |
| **Логування**            | loguru                  | Розширене логування                            |
| **Асинхронна аналітика** | asyncio.to_thread       | Запуск аналітичних обчислень у фоновому потоці |

---

## Тестування

* `pytest` + `pytest-asyncio` — юніт-тести ендпоінтів і аналітики.
* Мокування `asyncpg` при тестах інжесту.
* Генерація тестових подій для DAU/Retention.

---

## Ключові переваги рішення

* Висока продуктивність завдяки async-архітектурі
* Простота розгортання (Docker Compose)
* Гнучкість масштабування (додавання черг, реплік)
* Безпечна авторизація (JWT + Argon2)
* Стійкість до дублікатів подій (ON CONFLICT DO NOTHING)

---

## Підсумок

Архітектура поєднує **швидкий асинхронний інжест (PostgreSQL)** та **легку аналітику (DuckDB/Pandas)**.
Вона забезпечує **баланс між продуктивністю, простотою та можливістю подальшого масштабування**.
