# Event Analytics Service

Високопродуктивний асинхронний мікросервіс для інжесту, обробки та аналітики подій користувачів, реалізований на **FastAPI** + **Python** + **PostgresDB** + **DuckDB** + **Redis** + **Pandas** + **SQLAlchemy**.

---

## Зміст

* [Огляд](#огляд)
* [Функціонал](#функціонал)
* [Технологічний стек](#технологічний-стек)
* [Швидкий старт](#швидкий-старт)
* [Документація API (Swagger)](#документація-api-swagger)
* [Аутентифікація (JWT)](#аутентифікація-jwt)
* [Основні ендпоїнти](#основні-ендпоїнти)
* [Приклади запитів](#приклади-запитів)
* [Аналітичні метрики](#аналітичні-метрики)
* [Архітектурні рішення](#архітектурні-рішення)
* [Бенчмарки продуктивності](#бенчмарки-продуктивності)
* [Тестування](#тестування)
* [Контриб'юція](#контрибюція)
* [Ліцензія](#ліцензія)

---

## Огляд

Цей сервіс призначений для:

* Масового інжесту подій (асинхронно, ідемпотентно)
* Синхронізації OLTP → OLAP (Postgres → DuckDB через Pandas)
* Виконання аналітичних запитів (DAU, Top Events, Retention)
* Обмеження навантаження та безпечної автентифікації

---

## Функціонал

* Реєстрація та авторизація користувачів (JWT)
* Вставка великого об'єму подій (batch insert)
* Синхронізація даних у аналітичне сховище
* Метрики: DAU, Top Events, Retention (когортний аналіз)
* Rate limiting через Redis (fastapi-limiter)
* Логування через `loguru`
* Міграції БД через Alembic

---

## Технологічний стек

* Python 3.12
* FastAPI (асинхронний web-фреймворк)
* asyncpg / SQLAlchemy (асинхронний доступ до Postgres)
* DuckDB (аналітична частина, імітована через Pandas)
* Pandas (аналітичні обчислення)
* Redis (rate limiting, кеш)
* Docker + Docker Compose
* Pydantic (валидація)
* Alembic (міграції)
* Argon2 (хешування паролів)
* * JWT

---

## Швидкий старт

1. Клонуйте репозиторій:

```bash
git clone https://github.com/numerodiciannove/robomate-event-analytics-service
cd robomate-event-analytics-service
```

2. Запустіть всю інфраструктуру:

```bash
docker-compose up --build
```

> Примітка: контейнер `api` автоматично виконує міграції Alembic при старті та створює таблиці `users` та `events`.

---

## Документація API (Swagger)

Після запуску доступна за адресою:

```
http://localhost:5066/docs
```

---

## Аутентифікація (JWT)

1. **Реєстрація** — `POST /register`
   Тіло запиту: `{ "username": "user", "password": "pass" }`

3. **Додайте у Swagger** `Authorize` (правий верхній кут) як:

```
LOGIN PASS
```

---

## Основні ендпоїнти

* `POST /api/events` — інжест (масова вставка) подій
* `POST /api/stats/dau` — DAU за період
* `POST /api/stats/top-events` — Top N подій
* `POST /api/stats/retention` — когортний аналіз утримання


---

## Аналітичні метрики

* **DAU** — щоденна унікальна кількість користувачів.
* **Top Events** — частота появи подій (click, view, purchase).
* **Retention** — когорти: відсоток користувачів, що повернулися через N днів.

Аналітика виконується через Pandas/DuckDB для низьких латентностей при складних агрегаціях.

---

## Архітектурні рішення (ключові)

* **DataBaseHelper**: динамічний кеш підключень з автоматичним очищенням за 5 хв індикації — мінімізує витоки ресурсів в асинхронному середовищі.
* **Розділення OLTP/OLAP**: PostgreSQL для інжесту (ідемпотентність), DuckDB через Pandas для аналітики (швидкі агрегати, немає блокувань в OLTP).
* **Валідація**: Pydantic схеми для подій/користувачів.
* **Логування**: loguru для детального логування та відстеження проблем.

---

## Бенчмарки продуктивності

Тестування проводилося на пакетній вставці 100 000 унікальних подій (скрипт `data/query.py`).

| Ендпоїнт                     |             Операція | Результат (час) |
| ---------------------------- | -------------------: | --------------: |
| `POST /api/events`           | Інжест 100 000 подій |    **3.45 сек** |
| `POST /api/stats/top-events` |      Аналітика Top N |    **0.03 сек** |
| `POST /api/stats/dau`        |       Обчислення DAU |   **0.101 сек** |
| `POST /api/stats/retention`  |     Когортний аналіз |   **2.093 сек** |

> Висновок: система оптимізована для великого об'єму подій та швидкої аналітики.

---

## Тестування

* Використовуйте Swagger UI для інтерактивного тестування.
* Скрипт для генерації запросів 100К +: `data/query.py`

---

## Налаштування (конфіг)

Всі налаштування централізовано в модулі `app_config.py` або `settings`. Рекомендується перевірити:

* Параметри підключення до Postgres
* Redis URL
* Налаштування JWT (секрет, час життя токену)
* Параметри pool/timeout для asyncpg

---
